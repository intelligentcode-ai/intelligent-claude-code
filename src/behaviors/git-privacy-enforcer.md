# Git Privacy Enforcer

**Purpose:** Enforce git privacy settings by stripping AI mentions from commits  
**Type:** Security & Privacy Component  
**Status:** ACTIVE

## Git Privacy Implementation

### Core Privacy Enforcement

```pseudocode
CLASS GitPrivacyEnforcer:
    
    // Patterns to remove when git_privacy is enabled
    AI_PATTERNS = [
        // Direct mentions
        "AI-generated",
        "AI-assisted", 
        "AI assistant",
        "Claude",
        "Anthropic",
        
        // Emojis and markers
        "ðŸ¤–",
        "ðŸ§ ",
        "[AI]",
        "(AI)",
        
        // Co-authorship
        "Co-Authored-By: Claude",
        "Generated with Claude Code",
        "AI pair programming",
        
        // Indirect references
        "automated assistant",
        "intelligent system",
        "virtual developer"
    ]
    
    FUNCTION enforceGitPrivacy(content, settings):
        // Check if privacy is enabled
        IF NOT settings.git_privacy:
            RETURN content
        
        // Clean the content
        cleanedContent = content
        
        // Remove all AI patterns
        FOR pattern IN AI_PATTERNS:
            cleanedContent = removeAllOccurrences(cleanedContent, pattern)
        
        // Clean up any double spaces or empty lines
        cleanedContent = normalizeWhitespace(cleanedContent)
        
        // Ensure message still makes sense
        cleanedContent = ensureCoherence(cleanedContent)
        
        RETURN cleanedContent
    
    FUNCTION removeAllOccurrences(text, pattern):
        // Case-insensitive removal
        regex = createRegex(pattern, CASE_INSENSITIVE)
        result = regex.replaceAll(text, "")
        
        // Also remove sentence fragments that no longer make sense
        result = cleanOrphanedPhrases(result)
        
        RETURN result
    
    FUNCTION cleanOrphanedPhrases(text):
        // Remove phrases that no longer make sense after AI removal
        orphanPatterns = [
            "with assistance from\\s*",
            "helped by\\s*",
            "pair programmed with\\s*",
            "generated by\\s*",
            "created using\\s*"
        ]
        
        FOR pattern IN orphanPatterns:
            text = regex.replaceAll(text, pattern + "$", "")
        
        RETURN text
    
    FUNCTION ensureCoherence(text):
        // Fix capitalization after removals
        text = fixSentenceCapitalization(text)
        
        // Remove empty parentheses or brackets
        text = removeEmptyDelimiters(text)
        
        // Ensure at least one meaningful line remains
        IF text.trim().isEmpty():
            text = "Update implementation"
        
        RETURN text
```

### Git Operation Interceptors

```pseudocode
CLASS GitOperationInterceptor:
    enforcer: GitPrivacyEnforcer
    settings: Settings
    
    FUNCTION interceptCommit(message, files):
        // Load current settings (stateless)
        settings = getSettings()
        
        // Clean the commit message
        cleanMessage = enforcer.enforceGitPrivacy(message, settings)
        
        // Validate branch protection
        IF settings.branch_protection:
            validateBranchProtection()
        
        // Execute the commit
        executeGitCommit(cleanMessage, files)
    
    FUNCTION interceptPullRequest(title, description):
        // Load current settings (stateless)
        settings = getSettings()
        
        // Clean both title and description
        cleanTitle = enforcer.enforceGitPrivacy(title, settings)
        cleanDescription = enforcer.enforceGitPrivacy(description, settings)
        
        // Create the PR
        createPullRequest(cleanTitle, cleanDescription)
    
    FUNCTION validateBranchProtection():
        currentBranch = getCurrentBranch()
        defaultBranch = settings.default_branch
        
        IF currentBranch == defaultBranch:
            IF settings.require_pr_for_main:
                THROW "Direct commits to " + defaultBranch + " not allowed"
            ELSE:
                logWarning("Committing directly to " + defaultBranch)
```

### Integration with Workflow

```pseudocode
// Hook into the git operations phase of workflows
FUNCTION executeGitOperationsPhase(task, phase):
    IF phase.type == "git_operations":
        FOR step IN phase.steps:
            IF step.action == "commit":
                // Intercept and clean
                cleanedMessage = prepareCommitMessage(step.template, task)
                interceptCommit(cleanedMessage, task.files)
                
            ELSE IF step.action == "create_pr":
                // Intercept and clean
                cleanedTitle = preparePRTitle(step.title, task)
                cleanedDescription = preparePRDescription(step.body, task)
                interceptPullRequest(cleanedTitle, cleanedDescription)
```

### Privacy Preservation Examples

```yaml
examples:
  commit_message:
    before: "Implement user auth with Claude's assistance ðŸ¤–"
    after: "Implement user auth"
    
  pr_description:
    before: |
      This PR implements the new feature.
      
      Generated with Claude Code
      Co-Authored-By: Claude <noreply@anthropic.com>
    after: |
      This PR implements the new feature.
      
  complex_message:
    before: "Fix bug found by AI assistant in authentication flow"
    after: "Fix bug in authentication flow"
```

### Settings Integration

```pseudocode
FUNCTION applyGitSettings():
    settings = getSettings()
    
    // Configure git based on settings
    IF settings.branch_protection:
        enableBranchProtection(settings.default_branch)
    
    IF settings.require_pr_for_main:
        requirePullRequestsForBranch(settings.default_branch)
    
    // Set up hooks for privacy enforcement
    IF settings.git_privacy:
        installCommitMessageHook(enforceGitPrivacy)
        installPRCreationHook(enforceGitPrivacy)
```

### Error Handling

```pseudocode
FUNCTION handlePrivacyError(error):
    SWITCH error.type:
        CASE "EMPTY_MESSAGE":
            // Message became empty after cleaning
            RETURN "Update implementation"
            
        CASE "BRANCH_PROTECTED":
            // Tried to commit to protected branch
            promptForBranchSwitch()
            
        CASE "PATTERN_ERROR":
            // Regex or pattern matching failed
            logError("Privacy enforcement failed", error)
            RETURN originalMessage  // Fail open, not closed
```

### Testing Privacy Enforcement

```pseudocode
FUNCTION testPrivacyEnforcement():
    testCases = [
        {
            input: "Fixed bug with Claude's help",
            expected: "Fixed bug",
            setting: {git_privacy: true}
        },
        {
            input: "Fixed bug with Claude's help",
            expected: "Fixed bug with Claude's help",
            setting: {git_privacy: false}
        },
        {
            input: "ðŸ¤– AI-generated commit",
            expected: "Update implementation",
            setting: {git_privacy: true}
        }
    ]
    
    FOR test IN testCases:
        result = enforcer.enforceGitPrivacy(test.input, test.setting)
        ASSERT result == test.expected
```

## Usage

The Git Privacy Enforcer is automatically activated when:
1. Settings are loaded with `git_privacy: true`
2. Any git commit operation is performed
3. Pull requests are created
4. Merge commits are generated

No manual intervention needed - privacy is enforced transparently.

---
*Git privacy enforcement for intelligent-claude-code system*