---
# Intelligent Claude Code - Installation Playbook
# Runs from control machine, installs to targets via SSH
# NO Ansible required on target machines!

- name: Install Intelligent Claude Code
  hosts: all
  gather_facts: true
  vars:
    source_dir: "{{ playbook_dir }}/../src"

  tasks:
    - name: Determine installation scope and path
      ansible.builtin.set_fact:
        intelligent_claude_code_target_scope: "{{ 'project' if (target_path | default('')) else 'user' }}"
        intelligent_claude_code_install_path: >-
          {{ ((target_path | default('')) | realpath) + '/.claude'
          if (target_path | default(''))
          else ansible_env.HOME + '/.claude' }}
        intelligent_claude_code_project_path: >-
          {{ (target_path | default('')) | realpath
          if (target_path | default(''))
          else '' }}

    - name: Display installation target
      ansible.builtin.debug:
        msg: "Installing to: {{ intelligent_claude_code_install_path }}"
      when: ansible_verbosity >= 1

    - name: Include intelligent_claude_code role
      ansible.builtin.include_role:
        name: intelligent_claude_code
      vars:
        intelligent_claude_code_install_path: "{{ intelligent_claude_code_install_path }}"
        intelligent_claude_code_project_path: "{{ intelligent_claude_code_project_path }}"
        intelligent_claude_code_scope: "{{ intelligent_claude_code_target_scope }}"
        intelligent_claude_code_config_source: "{{ config_file | default('') }}"

    - name: Install MCP servers if configuration provided
      ansible.builtin.include_role:
        name: mcp-integration
      vars:
        mcp_integration_settings_json_path: "{{ ansible_env.HOME }}/.claude.json"
        mcp_integration_config_file: "{{ mcp_config_file | default('') }}"
      when: (mcp_config_file | default('')) != ''
