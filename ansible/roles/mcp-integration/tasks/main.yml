---
# MCP Server Integration Role - Main Tasks
# Handles MCP server configuration with comprehensive error handling and validation

- name: Initialize skip flag
  set_fact:
    skip_mcp_integration: false

- name: Validate MCP configuration JSON syntax
  include_tasks: validate_config.yml
  when: mcp_config_file is defined and mcp_config_file != ''

- name: Create backup of existing settings
  include_tasks: backup_settings.yml
  when: not skip_mcp_integration

- name: Load environment variables from .env file
  include_tasks: load_env.yml
  when: not skip_mcp_integration

- name: Process MCP configuration
  include_tasks: process_config.yml
  when: not skip_mcp_integration and mcp_config_file is defined and mcp_config_file != ''

- name: Merge MCP servers into settings
  include_tasks: merge_settings.yml
  when: not skip_mcp_integration

- name: Validate final configuration
  include_tasks: validate_final.yml
  when: not skip_mcp_integration

- name: Handle configuration errors
  include_tasks: error_handling.yml
  when: mcp_integration_error is defined

- name: Display integration summary
  debug:
    msg:
      - "MCP Integration completed successfully"
      - "Backup created: {{ settings_backup_file | default('N/A') }}"
      - "Settings updated: {{ settings_json_path | default('N/A') }}"
      - "MCP servers configured: {{ mcp_servers_count | default(0) }}"
  when: not skip_mcp_integration

- name: Display skip message
  debug:
    msg: "MCP Integration skipped - no configuration file provided"
  when: skip_mcp_integration