---
# Project-specific cleanup tasks
- name: Check if project CLAUDE.md exists
  ansible.builtin.stat:
    path: "{{ intelligent_claude_code_uninstall_project_path }}/CLAUDE.md"
  register: intelligent_claude_code_uninstall_project_claude_md_exists
  when: intelligent_claude_code_uninstall_project_path != ""
- name: Remove virtual team import from project CLAUDE.md
  ansible.builtin.lineinfile:
    path: "{{ intelligent_claude_code_uninstall_project_path }}/CLAUDE.md"
    regexp: '^@~/.claude/modes/virtual-team\.md\s*$'
    state: absent
    backup: true
  when:
    - intelligent_claude_code_uninstall_project_path != ""
    - intelligent_claude_code_uninstall_project_claude_md_exists.stat.exists
  register: intelligent_claude_code_uninstall_project_claude_cleanup
- name: Remove empty lines from project CLAUDE.md after import removal
  ansible.builtin.lineinfile:
    path: "{{ intelligent_claude_code_uninstall_project_path }}/CLAUDE.md"
    regexp: '^\s*$'
    state: absent
  when:
    - intelligent_claude_code_uninstall_project_path != ""
    - intelligent_claude_code_uninstall_project_claude_md_exists.stat.exists
    - intelligent_claude_code_uninstall_project_claude_cleanup.changed
- name: Check if project CLAUDE.md is now empty
  ansible.builtin.stat:
    path: "{{ intelligent_claude_code_uninstall_project_path }}/CLAUDE.md"
  register: intelligent_claude_code_uninstall_project_claude_md_after_cleanup
  when:
    - intelligent_claude_code_uninstall_project_path != ""
    - intelligent_claude_code_uninstall_project_claude_cleanup.changed
- name: Read project CLAUDE.md content to check if empty
  ansible.builtin.slurp:
    src: "{{ intelligent_claude_code_uninstall_project_path }}/CLAUDE.md"
  register: intelligent_claude_code_uninstall_project_claude_content
  when:
    - intelligent_claude_code_uninstall_project_path != ""
    - intelligent_claude_code_uninstall_project_claude_md_after_cleanup.stat.exists
- name: Determine if project CLAUDE.md is empty
  ansible.builtin.set_fact:
    intelligent_claude_code_uninstall_project_claude_empty: >-
      {{ intelligent_claude_code_uninstall_project_claude_content.content
      | b64decode | trim | length == 0 }}
  when:
    - intelligent_claude_code_uninstall_project_path != ""
    - intelligent_claude_code_uninstall_project_claude_content is defined
- name: Remove empty project CLAUDE.md file
  ansible.builtin.file:
    path: "{{ intelligent_claude_code_uninstall_project_path }}/CLAUDE.md"
    state: absent
  when:
    - intelligent_claude_code_uninstall_project_path != ""
    - intelligent_claude_code_uninstall_project_claude_empty | bool
- name: Display project cleanup results
  ansible.builtin.debug:
    msg:
      - "Project cleanup completed"
      - "Project path: {{ intelligent_claude_code_uninstall_project_path }}"
      - >-
        {{ 'CLAUDE.md import removed'
        if intelligent_claude_code_uninstall_project_claude_cleanup.changed
        else 'No project CLAUDE.md found or no changes needed' }}
      - >-
        {{ 'Empty CLAUDE.md file removed'
        if (intelligent_claude_code_uninstall_project_claude_empty | default(false))
        else 'Project CLAUDE.md preserved' }}
  when: intelligent_claude_code_uninstall_project_path != ""
