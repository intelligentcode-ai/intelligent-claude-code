---
# Project-specific integration tasks

- name: Check if project CLAUDE.md exists
  ansible.builtin.stat:
    path: "{{ claude_project_path }}/CLAUDE.md"
  register: project_claude_md

- name: Backup project CLAUDE.md if exists
  ansible.builtin.copy:
    src: "{{ claude_project_path }}/CLAUDE.md"
    dest: "{{ claude_project_path }}/CLAUDE.md.backup"
    remote_src: true
    mode: '0644'
  when: project_claude_md.stat.exists

- name: Create project CLAUDE.md with import
  ansible.builtin.copy:
    content: |
      # Virtual Development Team
      @~/.claude/modes/virtual-team.md

      <!-- Add your project-specific configuration below -->
    dest: "{{ claude_project_path }}/CLAUDE.md"
    mode: '0644'
  when: not project_claude_md.stat.exists

- name: Integrate with existing project CLAUDE.md
  when: project_claude_md.stat.exists
  block:
    - name: Ensure project CLAUDE.md includes import block
      ansible.builtin.blockinfile:
        path: "{{ claude_project_path }}/CLAUDE.md"
        marker: "<!-- {mark} ICC IMPORT -->"
        block: |
          # Virtual Development Team
          @~/.claude/modes/virtual-team.md
        insertbefore: BOF
      register: project_import_update

    - name: Report project integration status
      ansible.builtin.debug:
        msg: "{{ 'Added import to project CLAUDE.md' if project_import_update.changed else 'Project already integrated' }}"
