---
# Graceful integration with existing CLAUDE.md

- name: Check existing CLAUDE.md content
  ansible.builtin.command:
    cmd: grep -q "@~/.claude/modes/virtual-team.md" "{{ claude_install_path }}/CLAUDE.md"
  register: grep_result
  failed_when: false
  changed_when: false

- name: Integrate with existing CLAUDE.md
  when: grep_result.rc != 0
  block:
    - name: Read existing CLAUDE.md content
      ansible.builtin.slurp:
        src: "{{ claude_install_path }}/CLAUDE.md"
      register: existing_content

    - name: Create integrated CLAUDE.md
      ansible.builtin.copy:
        content: |
          # Virtual Development Team
          @~/.claude/modes/virtual-team.md

          <!-- Existing project configuration preserved below -->

          {{ existing_content.content | b64decode }}
        dest: "{{ claude_install_path }}/CLAUDE.md"
        mode: '0644'

    - name: Report graceful integration
      ansible.builtin.debug:
        msg: "Gracefully integrated with existing CLAUDE.md - all content preserved"

- name: Skip integration if already present
  ansible.builtin.debug:
    msg: "Already integrated - import line found in CLAUDE.md"
  when: grep_result.rc == 0
